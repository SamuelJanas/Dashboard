---
title: "Chessaholic"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    css: "style.css"
runtime: shiny
---


```{r global, include=FALSE}

source("funcs.R")
library(flexdashboard)
library(data.table)
library(stringr)
library(ggplot2)
library(DT)
library(tidyverse)

# Read the file
file_path <- "data/lichess_db.10.pgn"
file_lines <- readLines(file_path)

# Split the file into separate games
game_lines <- gamify(file_lines, delimiter="\\[Event")

# Create a single data.table
games_dt <- createGameDatatable(game_lines)
# drop all rows with NA anywhere
games_dt <- games_dt[complete.cases(games_dt),]

player_elo <- find_elo(games_dt)
# drop NA
player_elo <- player_elo[!is.na(player_elo$elo),]


selectedPlayers <- games_dt[, .(games = .N), by = white][order(-games)][1:50, white]
selectedPlayers <- c(selectedPlayers, games_dt[, .(games = .N), by = black][order(-games)][1:50, black])
selectedPlayers <- unique(selectedPlayers)

player_stats <- lapply(selectedPlayers, calculatePlayerStats)
player_stats <- rbindlist(player_stats)

```




ELO info
=====================================  
    
Column {data-width=600}
-------------------------------------
    
### Players are worse than you
    
```{r}

countPlayersBelow <- reactive({
  players_below <- player_elo[player_elo$elo <= input$elo_rating, ]
  count <- nrow(players_below)
  return(count)
})

renderValueBox({
  valueBox(
    countPlayersBelow(),
    "Players are worse than you",
    icon = "fa-poo",
    color = "#b58863"
  )
})

```


### Are awaiting for you to beat them

```{r}

countPlayersAbove <- reactive({
  players_above <- player_elo[player_elo$elo > input$elo_rating, ]
  count <- nrow(players_above)
  return(count)
})

renderValueBox({
  valueBox(
    countPlayersAbove(),
    "Are awaiting for you to beat them",
    icon = "fa-star",
    color = "#b58863"
  )
})

```

### You're here!

```{r}
output$elo_plot <- renderPlot({
  ggplot(player_elo, aes(x = elo)) +
    geom_histogram(binwidth = 50, fill = "black") +
    geom_vline(xintercept = input$elo_rating, linetype = "dashed", color = "red", size = 1.0) +
    theme_void()
})

plotOutput("elo_plot")


```
   
Column {data-width=450}
-------------------------------------

### Settings

```{r}

sliderInput("elo_rating", label = "ELO", min = 800, max = 2500, value = 1600, step = 50)

radioButtons("piece_color", label = "Color", choices = c("White", "Black"), selected = "White")

```

### Suggested openings:

```{r}


```


