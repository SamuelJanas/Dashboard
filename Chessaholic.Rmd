---
title: "Chessaholic"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    css: "style.css"
runtime: shiny
---


```{r global, include=FALSE}

source("funcs.R")
library(flexdashboard)
library(data.table)
library(stringr)
library(ggplot2)
library(DT)
library(tidyverse)

# Read the file
  file_path <- "data/lichess_db.10.pgn"
file_lines <- readLines(file_path)

# Split the file into separate games
game_lines <- gamify(file_lines, delimiter="\\[Event")

# Create a single data.table
games_dt <- createGameDatatable(game_lines)
# drop all rows with NA anywhere
games_dt <- games_dt[complete.cases(games_dt),]

player_elo <- find_elo(games_dt)
# drop NA
player_elo <- player_elo[!is.na(player_elo$elo),]


selectedPlayers <- games_dt[, .(games = .N), by = white][order(-games)][1:50, white]
selectedPlayers <- c(selectedPlayers, games_dt[, .(games = .N), by = black][order(-games)][1:50, black])
selectedPlayers <- unique(selectedPlayers)

player_stats <- lapply(selectedPlayers, calculatePlayerStats)
player_stats <- rbindlist(player_stats)

```



Introduction
=====================================

Column {data-width=600}
-------------------------------------

### Chessaholic is a simple tool to help you improve your chess skills.
#### It's purpose is to help you find the best openings for your level and encourage to level up in chess rankings.

Column {data-width=450}
-------------------------------------

### Quick insturction:

* choose your ELO rating with a slider
* enter color you want to play with
* check the suggested openings sorted by the win rate for your level
* play and win!

### examplery slider

```{r}

sliderInput("dummy_elo_rating", label = "ELO", min = 800, max = 2500, value = 1600, step = 50)

```

### your ELO

```{r}

renderValueBox({
  valueBox(
    input$dummy_elo_rating,
    if (input$dummy_elo_rating < 1000) {
      "Begginning of a journey, I see"
    } else if (input$dummy_elo_rating < 1300) {
       "You're getting there"
    } else if (input$dummy_elo_rating < 1600) {
       "Grind is real"
    } else if (input$dummy_elo_rating < 2000) {
       "Les go!"
    } else if (input$dummy_elo_rating < 2300) {
       "Impressive!!"
    } else {
       "Do your really need us?"
    },
    color = "#b58863"
  )
})

```


```{r}

radioButtons("dummy_piece_color", label = "Color", choices = c("White", "Black"), selected = "White")

```


```{r}

sliderInput("elo_rating", label = "ELO", min = 800, max = 2500, value = 1600, step = 50)

radioButtons("piece_color", label = "Color", choices = c("White", "Black"), selected = "White")

```



ELO info
=====================================  
    
Column {data-width=600}
-------------------------------------
    
### Players are worse than you
    
```{r}

countPlayersBelow <- reactive({
  players_below <- player_elo[player_elo$elo <= input$elo_rating, ]
  count <- nrow(players_below)
  return(count)
})

renderValueBox({
  valueBox(
    countPlayersBelow(),
    "Players are worse than you",
    icon = "fa-poo",
    color = "#b58863"
  )
})

```


### Are awaiting for you to beat them

```{r}

countPlayersAbove <- reactive({
  players_above <- player_elo[player_elo$elo > input$elo_rating, ]
  count <- nrow(players_above)
  return(count)
})

renderValueBox({
  valueBox(
    countPlayersAbove(),
    "Are awaiting for you to beat them",
    icon = "fa-star",
    color = "#b58863"
  )
})

```

### You're here!

```{r}
output$elo_plot <- renderPlot({
  ggplot(player_elo, aes(x = elo)) +
    geom_histogram(binwidth = 50, fill = "black") +
    geom_vline(xintercept = input$elo_rating, linetype = "dashed", color = "red", size = 1.0) +
    theme_void()
})

plotOutput("elo_plot")


```
   
Column {data-width=450}
-------------------------------------

### Settings

```{r}

sliderInput("elo_rating", label = "ELO", min = 800, max = 2500, value = 1600, step = 50)

radioButtons("piece_color", label = "Color", choices = c("White", "Black"), selected = "White")

```

### Suggested openings:

```{r}

filtered_openings <- reactive({
  # take only the games where white_elo is above input$elo_rating or black_elo is above input$elo_rating
  filtered <- games_dt[white_elo > input$elo_rating | black_elo > input$elo_rating, ]

  # choose only the opening and result columns
  filtered <- filtered[, .(opening, result)]

  # group by opening, sum the number of games and wins
  if (input$piece_color == "White") {
    filtered <- filtered[, .(games = .N, wins = sum(result == "1-0")), by = opening]
  } else {
    filtered <- filtered[, .(games = .N, wins = sum(result == "0-1")), by = opening]
  }

  # change wins to win_rate rounded to 2 decimals
  filtered[, win_rate := round(wins / games, 2)]

  # drop openings with less than 20 games
  filtered <- filtered[games >= 20]

  # delete the opening named '?'
  filtered <- filtered[opening != "?"]

  # sort by win rate
  filtered <- filtered[order(-win_rate)]

  return(filtered) 
})

renderDataTable({
  filtered_openings()
})

```

```


